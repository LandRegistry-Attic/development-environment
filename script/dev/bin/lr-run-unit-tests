#!/bin/bash

#Uncomment this line if you want to debug this script
#set -x
set -e

case `uname` in
    Linux)
        if [[ ! -d /vagrant ]] ; then
            echo "You need to be running in the vagrant VM to do this"
            exit 1
        fi
    ;;

    *)
        echo
        echo
        echo "You need to be running in your vagrant virtual machine to run this."
        echo
        echo "Run vagrant ssh from the root directory of the development environment and then re-run this script"
        echo
        exit 1
    ;;
esac

source /vagrant/script/checkout
lr-bootstrap

if [[ ! -d ./tests ]] ; then
    echo "No unit tests found in directory `pwd`/tests"
else
    app_to_test=$(basename `pwd`)
    check_all_apps_are_valid ${app_to_test}
    configure_virtual_env_for_apps ${app_to_test} 
    
    if [[ -z ${SETTINGS} ]] ; then
        echo "Configuring SETTINGS to be config.TestConfig"
        echo "Please ensure you have a config.TestConfig in your project"
        export SETTINGS="config.TestConfig"
    fi

    set +o errexit
    workon ${app_to_test}
    SETTINGS='config.DevelopmentConfig' PORT=$(get_port_for_app $1) py.test 
    set -e
fi