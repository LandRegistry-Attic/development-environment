#!/bin/bash

#Uncomment this line if you want to debug this script
#set -x
set -e

case `uname` in
	Linux)
		if [[ ! -d /vagrant ]] ; then
			echo "You need to be running in the vagrant VM to do this"
			exit 1
		fi
	;;

	*)	
		echo
		echo
		echo "You need to be running in your vagrant virtual machine to run this."
		echo
		echo "Run vagrant ssh from the root directory of the development environment and then re-run this script"
		echo
		exit 1
	;;
esac

source /vagrant/script/checkout

apps_to_start=(${@})
first_arg=${apps_to_start[0]}

if [ -z ${first_arg} ]; then
	# We've not been called with any arguments. Let's see if we're in an
	# application directory with a run.sh

	if [ -f ./run.sh ]; then
	  	apps_to_start=$(basename `pwd`)
	else
		die_cant_find_any_apps
	fi
fi

check_all_apps_are_valid ${apps_to_start}
configure_virtual_env_for_apps ${apps_to_start}

# TODO: MW - tech debt --
# Currently our run.sh scripts in the apps don't always work with set -e in place
# because we're not running proper database migrations.
# Until we've sorted out the apps we'll disable -e here

set +o errexit
PORT=$(get_port_for_app $1) source run.sh
deactivate
set -e
